import json
from typing import Dict, List, Union
from openai import OpenAI
from dotenv import load_dotenv
import os

load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=OPENAI_API_KEY)


def action_guide_agent(category: str, user_question: str) -> Dict[str, Union[str, List[str]]]:
    """
    예측된 법률 카테고리와 사용자 질문을 기반으로
    신고 및 대응 절차를 반환하는 함수.
    사전 정의된 안내가 없을 경우 GPT를 호출하여 안내 생성.
    """
    guide = {
        "초상권 침해": (
            "1. 개인정보보호법 위반 여부 검토: 타인의 얼굴, 모습 등은 식별 가능한 영상 정보로서 개인정보에 해당할 수 있으며, 업무를 목적으로 하는 개인정보 처리자가 동의 없이 이를 수집·이용·제공하는 경우 개인정보보호법 위반이 될 수 있습니다 (제2조, 제15조, 제17조 등).\n"
            " (개인이 반복적·상습적으로 타인의 개인정보를 조직적으로 수집·이용하는 경우에는 예외적으로 개인정보처리자로 간주될 수 있습니다.)\n"
            "   - 개인정보보호법 제71조: 법 위반 행위가 중대한 경우 과태료 또는 형사처벌 대상이 될 수 있습니다.\n"
            "2. SNS 게시물 삭제 요청: 해당 게시물의 플랫폼 고객센터 또는 게시자에게 삭제를 요청하세요. 대부분의 SNS는 신고 또는 삭제 요청 기능을 제공합니다.\n"
            "3. 증거 확보: 무단 촬영·유포된 사진, 영상, 게시물의 원본과 URL, 캡처본, 유포 경로, 시점 등을 최대한 확보하세요. 상대방과의 대화 내용이나 동의 여부가 드러나는 자료도 중요합니다.\n"
            "4. 민사소송 제기: 초상권 침해로 인한 정신적·재산적 피해에 대해 손해배상을 청구할 수 있습니다 (민법 제750조, 제751조).\n"
            "5. 형사처벌 가능성 검토:\n"
            "   - 성폭력처벌법 제14조(카메라 등 이용촬영죄): 동의 없이 신체를 촬영하거나 유포한 경우, 5년 이하 징역 또는 3천만 원 이하 벌금에 처해질 수 있습니다.\n"
            "   - 정보통신망법상 명예훼손죄·모욕죄: 초상권 침해가 타인의 명예나 인격을 훼손한 경우 형사처벌이 가능합니다.\n"
            "   - 형법상 사생활 침해: 주거 등 고도의 사적 공간에서의 무단 촬영·유포는 형사처벌 대상이 될 수 있습니다.\n"
            "6. 방송통신심의위원회 신고: 온라인에 게시된 유해 게시물은 방송통신심의위원회를 통해 심의 및 삭제 요청이 가능합니다.\n"
            "   → https://www.kocsc.or.kr/\n"
            "7. 법률 전문가 상담: 상대방이 대응을 거부하거나 상황이 복잡한 경우, 변호사 등 법률 전문가의 조력을 받아 전략적으로 대응하세요.\n"
            "   - 합의가 가능하다면 원만한 해결을 시도하되,\n"
            "   - 반복적·악의적 침해라면 형사고소 및 손해배상 등 강경 대응이 필요합니다.\n"
            "   - 대한법률구조공단 등 무료 법률상담 서비스도 활용 가능합니다.\n"
        ),
          "동의 없는 개인정보 수집": (
        "1. 먼저 개인정보 수집 사실을 입증할 수 있는 자료(화면 캡처, 수신 내역 등)를 확보하세요.\n"
        "2. 개인정보보호법 제15조에 따라 개인정보를 수집하려면 정보주체의 명시적인 동의가 있어야 하며,\n"
        "   동의 없이 수집한 경우 이는 명백한 법 위반입니다.\n"
        "3. 제15조 제2항에 따르면 수집 시에는 수집 목적, 항목, 보유 기간, 동의 거부 권리 등을 고지해야 하며,\n"
        "   이를 이행하지 않은 경우에도 위법이 됩니다.\n"
        "4. 해당 업체나 기관에 정보 삭제 및 처리 정지 요청을 문서로 요구하세요.\n"
        "5. 시정되지 않을 경우, 개인정보보호위원회에 온라인 민원을 제기할 수 있습니다.\n"
        "   → https://www.pipc.go.kr/\n"
        "6. 반복되거나 고의성이 있는 경우, 민사 손해배상 청구도 검토 가능합니다 (민법 제750조, 제751조)"
        ),
       "목적 외 이용": (
        "1. 개인정보보호법 제18조에 따르면, 개인정보처리자는 개인정보를 수집한 목적 외로 이용해서는 안 됩니다.\n"
        "2. 예외적으로 제18조 제2항에서 열거된 상황(정보주체 동의, 법률 규정, 공공안전 등) 외에는 목적 외 이용이 제한됩니다.\n"
        "3. 우선 해당 기관 또는 업체에 '당초 동의한 목적과 다른 용도'로 개인정보가 사용된 사실을 명시하여 이용 중지 및 삭제를 요청하세요.\n"
        "4. 요청 시에는 관련 증거(이용 내역, 서비스 약관, 수신 내역 등)를 함께 제출하는 것이 좋습니다.\n"
        "5. 요청을 무시하거나 부당하게 거부하는 경우, 개인정보보호위원회에 민원을 제기할 수 있습니다.\n"
        "   → https://www.pipc.go.kr/\n"
        "6. 반복적이거나 명백한 고의성이 있다면 민사상 손해배상 청구(민법 제750조)도 고려 가능합니다."
         ),
 
        "제3자 무단 제공": (
        "1. 개인정보보호법 제17조와 제18조에 따르면, 개인정보를 제3자에게 제공하려면 반드시 정보주체의 사전 동의를 받아야 하며, 제공 목적과 범위 내에서만 제공되어야 합니다.\n"
        "2. 본인의 동의 없이 개인정보가 제3자에게 제공된 경우 이는 위법에 해당하며, 해당 행위자는 제19조에 따라 제공받은 자의 이용 제한 의무도 위반할 수 있습니다.\n"
        "3. 먼저 개인정보가 무단으로 제공된 정황이나 증거(이메일, 문자, 서비스 약관, 동의 내역 등)를 확보하세요.\n"
        "4. 해당 업체 또는 기관에 정보 제공 경위에 대한 공식적인 설명과 관련 자료를 요청하고, 정보 삭제 및 재발 방지를 요구하세요.\n"
        "5. 업체가 회신하지 않거나 납득할 만한 설명 없이 거부할 경우, 개인정보보호위원회 또는 한국인터넷진흥원(KISA)에 다음과 같이 신고할 수 있습니다:\n"
        "   - 개인정보침해 신고센터: https://privacy.kisa.or.kr/\n"
        "   - 전화: 118 (개인정보 민원상담)\n"
        "6. 피해 정도가 중대하거나 반복적인 경우에는 민사상 손해배상 청구(민법 제750조) 또는 형사 고소도 검토할 수 있습니다.\n"
        "7. 특히 공공기관의 경우, 목적 외 이용 또는 제3자 제공 시에는 법적 근거 및 제공 내역을 인터넷 등에 고시해야 하며(제18조 제4항), 이 의무를 위반했는지 여부도 확인하세요."


        ),
        "CCTV 과잉촬영": (
        "1. CCTV가 설치된 장소에서 불필요하게 촬영되거나 사생활이 침해되는 경우,\n"
        "   - 우선 촬영 범위, 안내판 설치 여부, 녹음 금지 여부 등 관련 증거(사진, 동영상, 녹취 등)를 확보하세요.\n"
        "2. 고정형 영상정보처리기기 설치 및 운영은 개인정보보호법 제25조와 관련 고시에 따라 엄격히 관리되어야 하며,\n"
        "   - 안내판 미설치, 녹음 금지 위반, 임의 조작 등 위법 사례는 정보주체의 권리 침해입니다.\n"
        "3. 사생활 침해가 우려되는 경우 설치자(관리 기관 또는 업체)에 문제 사실을 서면(이메일 또는 등기)으로 알리고,\n"
        "   - 촬영 범위 축소, 불필요한 영상 삭제, 운영 중단 등을 공식 요구할 수 있습니다.\n"
        "4. 설치자 대응이 없거나 개선되지 않을 경우,\n"
        "   - 개인정보보호위원회(https://www.pipc.go.kr) 또는 관할 구청에 민원을 제기하세요.\n"
        "5. 심각한 사생활 침해 및 불법 촬영 의심 시,\n"
       "   - 경찰 또는 사이버범죄 신고센터에 형사 고소를 고려할 수 있습니다.\n"
        "6. CCTV 영상의 무단 유출 시 개인정보보호법에 따라 징역 또는 벌금형이 처해질 수 있으니,\n"
        "   - 피해 사실을 인지한 즉시 관련 기관에 신고하여 보호를 요청하세요."
        ),

        "정보 유출": (
        "1. 개인정보가 유출되었다고 의심되는 경우, 해당 기관 또는 기업에 즉시 문의하여\n"
        "   - 유출 경위, 유출된 정보 항목, 재발방지 대책, 피해구제 절차 등을 요청하세요.\n"
        "2. 기관이 1천명 이상에게 유출되었거나 주민등록번호 등 중요한 정보가 포함된 경우,\n"
        "   - 개인정보보호법 제34조에 따라 해당 기관은 유출 사실을 정보주체(당사자)에게 통보해야 합니다.\n"
        "3. 통지 의무를 이행하지 않거나 유출 사실을 은폐한 정황이 있다면,\n"
        "   - 개인정보보호위원회(https://www.pipc.go.kr) 또는 KISA(https://privacy.kisa.or.kr)에 신고할 수 있습니다.\n"
        "4. 피해가 발생했거나 정신적 고통이 클 경우,\n"
        "   - 민법 제750조 및 제751조에 따라 손해배상 소송을 제기할 수 있으며,\n"
        "   - 게시물 캡처, 이메일, 대화 기록 등 증거를 수집해두는 것이 좋습니다.\n"
        "5. 유출된 정보로 인한 2차 피해(스미싱, 계정 탈취 등)가 우려된다면 즉시 관련 비밀번호를 변경하고,\n"
        "   - 필요 시 경찰청 사이버수사국 또는 금융보안원에도 문의하세요."
        ),

        "파기 미이행": (
        "1. 회원 탈퇴 또는 서비스 이용 종료 이후에도 개인정보가 계속 보관되고 있다면,\n"
        "   - 개인정보보호법 제21조에 따라 '처리 목적 달성 후 지체 없이 파기'해야 하므로,\n"
        "   - 해당 기관 또는 사업자에 '개인정보 파기 요청서'를 공식적으로 제출하세요.\n"
        "2. 요청 시에는 다음 내용을 포함하는 것이 좋습니다:\n"
        "   - 탈퇴 날짜, 저장된 항목(예: 이름, 이메일), 파기 요청 사유, 회신 요청 기한 등\n"
        "3. 정당한 사유 없이 파기를 거부하거나 무응답일 경우,\n"
        "   - 개인정보보호위원회(https://www.pipc.go.kr) 또는 KISA(https://privacy.kisa.or.kr)에 신고할 수 있습니다.\n"
        "   - 위반 시 최대 5천만 원의 과태료가 부과될 수 있습니다 (법 제73조 참조).\n"
        "4. 장기간 미사용 계정의 개인정보 보관도 불법일 수 있으며,\n"
        "   - 최소 1년 이상 미이용 시 '별도 분리 보관' 또는 파기해야 하므로 (시행령 제48조의2),\n"
        "   - 이런 사실을 확인한 경우에도 위원회 신고 대상이 됩니다.\n"
        "5. 추후 법적 분쟁이나 소송 가능성에 대비해,\n"
        "   - 요청 기록(이메일, 등기 발송증명), 회신 내역 등은 증거로 보관하세요."
       ),

        "계정/비밀번호 관련 문제": (
        "1. 계정 정보가 유출되거나 의심되는 경우 즉시 비밀번호를 변경하고,\n"
        "   - 가능하면 2단계 인증(OTP, 문자 인증 등)을 반드시 설정하여 보안을 강화하세요.\n"
        "2. 사용 중인 서비스 제공자 고객센터에 신속히 신고하고,\n"
        "   - 계정 복구 및 이상 활동 모니터링을 요청하세요.\n"
        "3. 동일한 피해가 반복될 경우,\n"
        "   - 개인정보보호법 및 정보통신망법에 따라 개인정보 유출 신고를 개인정보보호위원회 또는 한국인터넷진흥원(KISA)에 할 수 있습니다.\n"
        "4. 악성 해킹이나 금융 피해가 의심되면, 경찰 사이버수사대에 신속히 신고하여 수사 협조를 받으세요."
       ),

        "위치정보 수집/유출": (
        "1. 내 위치정보가 무단으로 수집되거나 제3자에게 넘어간 정황이 있다면, 먼저 해당 앱이나 서비스에서 수집 내역을 확인하고, 캡처 등으로 증거를 확보하세요.\n"
        "2. 위치정보를 수집·제공한 사업자에게 서면이나 이메일로 정보 삭제 요청 및 유출 경위 설명을 요구하세요.\n"
        "3. 위치정보사업자 또는 위치기반서비스사업자는 『위치정보 보호법』에 따라 동의 없이 수집·제공하면 법적 책임이 있습니다.\n"
        "4. 요청에 응답하지 않거나 부정확한 답변을 할 경우, 방송통신위원회 민원센터 또는 경찰청 사이버수사국에 신고할 수 있습니다.\n"
        "5. 추가 피해(스토킹, 협박 등)가 우려되는 경우, 즉시 경찰에 신고하고 위치정보 사용 제한 조치를 요구하세요."
       ),  
       
        "개인정보 열람·정정 요구 거부": (
        "1. 내가 제공한 개인정보를 열람하거나 정정하려 했는데 사업자가 이를 부당하게 거부한 경우, 먼저 요청 내역을 문서나 이메일로 다시 남겨 기록을 확보하세요.\n"
        "2. 개인정보보호법에 따라 이용자는 자신의 개인정보에 대해 열람·정정할 권리가 있으며, 사업자는 이에 10일 이내에 응답해야 합니다.\n"
        "3. 재요청에도 응답이 없거나 거부 사유가 불명확하다면, 개인정보보호위원회 홈페이지(https://www.pipc.go.kr)를 통해 민원을 제기할 수 있습니다.\n"
        "4. 특히 개인정보로 인해 부정확한 서비스 제공이나 불이익이 발생했다면, 관련 피해 사실을 함께 첨부하여 시정을 요구하세요.\n"
        "5. 추후 법적 대응이 필요할 수 있으므로 요청 내역, 회신 내용 등은 모두 증거로 보관해두는 것이 좋습니다."
       )

    }

    if category in guide:
        guide_text = guide[category]
        steps = [line.strip() for line in guide_text.split("\n") if line.strip()]
    
    else:
        # GPT 호출
        prompt = f"""
        당신은 개인정보 보호 및 디지털 권리 침해에 대한 법률 상담 전문가입니다.
        아래는 사용자 질문과 예측된 법률 카테고리입니다.
        이 정보에 기반하여 '신고 및 대응 절차'를 구체적이고 단계적으로 작성해주세요.

        [예측된 법률 카테고리]
        {category}

        [사용자 질문]
        {user_question}

        요구사항:
        - 신고 방법, 기관 이름, 소송 등 실질적인 대응 조치를 단계별로 안내하세요.
        - 관련 기관 웹사이트나 전화번호가 있다면 포함하세요.
        - 사용자가 실제 행동할 수 있도록 구체적으로 작성하세요.
        """

        response = client.chat.completions.create(
            model="gpt-4.1",
            messages=[
                {"role": "system", "content": "당신은 법률 상담 전문가입니다."},
                {"role": "user", "content": prompt}
            ],
            stream=True
        )
        
    return response
